name: Build and Release

on:
  push:
    branches: [main]
    tags:
      - "v*.*.*"
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 6.0.x

      - name: Build IL2CPP
        run: dotnet build -c IL2CPP

      - name: Build Mono
        run: dotnet build -c Mono

      - name: Upload IL2CPP artifact
        uses: actions/upload-artifact@v4
        with:
          name: EasierSleep-IL2CPP
          path: bin/IL2CPP/net6.0/EasierSleep.dll
          retention-days: 90

      - name: Upload Mono artifact
        uses: actions/upload-artifact@v4
        with:
          name: EasierSleep-Mono
          path: bin/Mono/net6.0/EasierSleep.dll
          retention-days: 90

      # Only run release step if this is a tag push
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            bin/IL2CPP/net6.0/EasierSleep.dll
            bin/Mono/net6.0/EasierSleep.dll
          generate_release_notes: true
          body: |
            ## üåô EasierSleep ${{ github.ref_name }}

            **Percentage-based multiplayer sleep system - no more waiting for AFK players!**

            ### üì¶ Installation

            1. Download `EasierSleep.dll` (IL2CPP build recommended)
            2. Copy to `Schedule I/Mods/` folder
            3. Launch the game!

            ### ‚öôÔ∏è Configuration

            Edit `Schedule I/UserData/MelonPreferences.cfg`:

            ```ini
            [EasierSleep]
            SleepThreshold = 75      # Percentage needed (1-100)
            EnableMod = true         # Turn mod on/off
            EnableDebugLogs = true   # Console output
            ```

            ### üì¶ Which Build?

            - **EasierSleep.dll** (IL2CPP) - ‚≠ê **Use this one** for most installations
            - **EasierSleep-Mono.dll** - Alternative Mono build (if IL2CPP doesn't work)

            ### üìù Full Changelog

            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)

            ---

            üíù **Support:** [Open an issue](https://github.com/${{ github.repository }}/issues) ‚Ä¢ [View source](https://github.com/${{ github.repository }})
          draft: false
          prerelease: false
